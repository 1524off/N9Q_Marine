<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arrival Marine（UTC）</title>
<style>
:root{
  --brand:#1565C0; --brand-2:#1976d2;
  --bg:#f7f9ff; --text:#1f2937; --line:#d7deeb;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
     font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
header.appbar{
  background:var(--brand); color:#fff; padding:10px 14px;
  display:flex; align-items:center; justify-content:space-between;
}
.appbar .title{font-weight:800;letter-spacing:.5px}
.appbar .badge{
  background:rgba(255,255,255,.2); padding:4px 10px; border-radius:10px;
  font-family:"Roboto Mono",monospace; font-weight:700;
}
main{max-width:720px;margin:0 auto;padding:12px}
.card{
  background:#fff;border:1px solid var(--line);border-radius:14px;
  box-shadow:0 1px 4px rgba(0,0,0,.05); padding:14px; margin:12px 0;
}

/* 共通UI */
label{font-size:13px;color:#374151;font-weight:600}
select,input[type="text"]{
  width:100%; padding:8px 10px; font-size:15px; background:#fbfdff;
  border:1px solid var(--line); border-radius:12px;
}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.row.center{justify-content:center}
.btn{
  border:none;border-radius:12px;font-weight:800;cursor:pointer;transition:.15s
}
.btn:active{transform:scale(.98)}
.btn-primary{background:var(--brand);color:#fff;padding:12px 16px}
.btn-primary:hover{background:var(--brand-2)}
.btn-ghost{background:#eef3ff;color:var(--brand);padding:8px 12px}
.btn-danger{background:#fee2e2;color:#b91c1c;padding:8px 12px}

.helper{font-size:12px;color:#6b7280}

/* 被せの一行：⬜ 秒後に ⬜ 分集結 */
.pill-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center}
.pill-row select{width:90px;text-align:center}

/* 着弾の 12 : 00 : 00 */
.time-row{display:flex;align-items:center;gap:8px;justify-content:center}
.time-row select{width:90px;text-align:center}

/* テーブル */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;text-align:center;font-size:14px}
th,td{border:1px solid var(--line);padding:8px}
th{background:#eef3ff;color:#0f4aa8;font-weight:700}
tbody tr:nth-child(odd){background:#fafcff}
tr.pet-on{background:#eaf3ff!important}

/* ペット列の表示/非表示 */
.hide-pet th:first-child,.hide-pet td:first-child,
.hide-pet th:last-child,.hide-pet td:last-child{display:none}

/* コピー欄 */
.copy{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;
      background:#fbfdff;border:1px solid var(--line);border-radius:12px;
      padding:10px;min-height:68px}
.footer{color:#9aa3b2;text-align:center;font-size:12px;padding:18px 0 28px}
</style>
</head>
<body>
<header class="appbar">
  <div class="title">Arrival Marine</div>
  <div class="badge">UTC: <span id="utcClock">--:--:--</span></div>
</header>

<main>
  <!-- モード＆入力 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <label>モード選択：</label>
      <select id="mode" style="max-width:220px">
        <option value="normal" selected>被せ集結</option>
        <option value="reverse">着弾時刻指定</option>
      </select>
    </div>

    <!-- 被せ -->
    <div id="box-normal" style="margin-top:10px">
      <div class="pill-row">
        <select id="prep"><option>30</option><option>60</option><option>90</option><option>120</option></select>
        <span>秒後に</span>
        <select id="rally"><option>5</option><option>10</option><option>15</option></select>
        <span>分集結</span>
      </div>
      <div class="row center" style="margin-top:8px">
        <button id="fireNormal" class="btn btn-primary">集結がきた！</button>
        <button id="addRow" class="btn btn-ghost">＋ 追加</button>
        <button id="removeRow" class="btn btn-danger">− 削除</button>
      </div>
      <p id="normalPreview" class="helper" style="text-align:center;margin-top:6px">
        共通着弾予定：--:--:-- UTC
      </p>
    </div>

    <!-- 着弾指定 -->
    <div id="box-reverse" style="display:none;margin-top:10px">
      <div class="time-row">
        <select id="hh"></select> <span>:</span>
        <select id="mm"></select> <span>:</span>
        <select id="ss"></select>
      </div>
      <p id="revPreview" class="helper" style="text-align:center;margin-top:6px">
        着弾予定時刻：--:--:-- UTC
      </p>
      <div class="row center">
        <span>分集結</span>
        <select id="rallyReverse" style="width:90px"><option>5</option><option>10</option><option>15</option></select>
      </div>
      <div class="row center" style="margin-top:8px">
        <button id="fireReverse" class="btn btn-primary">計算する</button>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <label class="helper"><input type="checkbox" id="togglePet" checked> ペット表示</label>
    </div>
  </section>

  <!-- テーブル -->
  <section class="card table-wrap">
    <table id="tbl">
      <thead>
        <tr><th>🐶</th><th>集結主</th><th>行軍（秒）</th><th>出発（UTC）</th><th>残り🐾</th></tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td><input type="checkbox" class="pet"></td>
          <td><input type="text" placeholder="例：Marine"></td>
          <td><select class="march"></select></td>
          <td>-</td><td class="pet-left">-</td>
        </tr>
        <tr>
          <td><input type="checkbox" class="pet"></td>
          <td><input type="text" placeholder="例：Yumi"></td>
          <td><select class="march"></select></td>
          <td>-</td><td class="pet-left">-</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- コピー -->
  <section class="card">
    <label>コピー用メッセージ</label>
    <div id="copyBox" class="copy">（計算するとここに整形テキストが出ます）</div>
    <div class="row center" style="margin-top:8px">
      <button id="copyBtn" class="btn btn-ghost">コピー</button>
    </div>
  </section>
</main>

<div class="footer">© Arrival Marine</div>

<script>
// ===== 共通ユーティリティ =====
const pad = n => String(n).padStart(2,'0');
const fmtUTC = d => `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
const nowUTC = () => new Date();
setInterval(()=>{document.getElementById('utcClock').textContent=fmtUTC(nowUTC());},1000);

// ===== 行軍セレクト: 34〜180秒 =====
function fillMarch(sel){
  for(let s=34;s<=180;s++){
    const m=Math.floor(s/60), sec=s%60;
    sel.add(new Option((m?`${m}分`:'')+`${sec}秒`, s));
  }
}
document.querySelectorAll('.march').forEach(fillMarch);

// ===== 着弾指定プルダウン =====
(function(){
  const hh=document.getElementById('hh'), mm=document.getElementById('mm'), ss=document.getElementById('ss');
  for(let h=0;h<24;h++) hh.add(new Option(pad(h), h));
  for(let m=0;m<60;m+=5) mm.add(new Option(pad(m), m)); // 5分刻み
  for(let s=0;s<60;s+=10) ss.add(new Option(pad(s), s)); // 10秒刻み
  const now=nowUTC(); hh.value=now.getUTCHours(); mm.value=Math.floor(now.getUTCMinutes()/5)*5; ss.value=0;
})();

// ===== モード切り替え =====
const modeSel=document.getElementById('mode');
function applyMode(){
  const rev=modeSel.value==='reverse';
  document.getElementById('box-normal').style.display = rev ? 'none':'block';
  document.getElementById('box-reverse').style.display = rev ? 'block':'none';
}
modeSel.addEventListener('change',applyMode); applyMode();

// ===== ペット表示 ON/OFF =====
const tbl=document.getElementById('tbl');
document.getElementById('togglePet').addEventListener('change',e=>{
  tbl.classList.toggle('hide-pet', !e.target.checked);
});

// ===== ペット2時間カウント =====
const PET_MS = 2*60*60*1000;
function bindPetHandlers(scope=document){
  scope.querySelectorAll('.pet').forEach(cb=>{
    cb.onchange = ()=>{
      const row = cb.closest('tr');
      const cell = row.querySelector('.pet-left');
      if(cb.checked){
        row.dataset.petEnd = (Date.now()+PET_MS).toString();
        row.classList.add('pet-on');
      }else{
        row.classList.remove('pet-on');
        cell.textContent='-';
        delete row.dataset.petEnd;
      }
    };
  });
}
bindPetHandlers();
setInterval(()=>{
  document.querySelectorAll('#tbody tr').forEach(row=>{
    if(!row.dataset.petEnd) return;
    const diff = row.dataset.petEnd - Date.now();
    const cell = row.querySelector('.pet-left');
    if(diff<=0){ cell.textContent='⚫ 終了'; row.classList.remove('pet-on'); delete row.dataset.petEnd; return; }
    const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
    cell.textContent = `🐶 ${h}:${pad(m)}:${pad(s)}`;
  });
},1000);

// ===== 行の追加/削除 =====
document.getElementById('addRow').onclick=()=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="checkbox" class="pet"></td>
    <td><input type="text" placeholder="名前"></td>
    <td><select class="march"></select></td>
    <td>-</td><td class="pet-left">-</td>`;
  document.getElementById('tbody').appendChild(tr);
  fillMarch(tr.querySelector('.march'));
  bindPetHandlers(tr);
};
document.getElementById('removeRow').onclick=()=>{
  const rows = document.querySelectorAll('#tbody tr');
  if(rows.length>1) rows[rows.length-1].remove();
};

// ===== リアルタイムプレビュー（被せ／着弾）=====
function updateNormalPreview(){
  const prep=+document.getElementById('prep').value;
  const rally=+document.getElementById('rally').value;
  const impact = new Date(nowUTC().getTime()+prep*1000+rally*60*1000);
  document.getElementById('normalPreview').textContent = `共通着弾予定：${fmtUTC(impact)} UTC`;
}
['prep','rally'].forEach(id=>document.getElementById(id).addEventListener('change',updateNormalPreview));
function updateRevPreview(){
  const hh=+document.getElementById('hh').value, mm=+document.getElementById('mm').value, ss=+document.getElementById('ss').value;
  document.getElementById('revPreview').textContent = `着弾予定時刻：${pad(hh)}:${pad(mm)}:${pad(ss)} UTC`;
}
['hh','mm','ss'].forEach(id=>document.getElementById(id).addEventListener('change',updateRevPreview));
updateNormalPreview(); updateRevPreview();

// ===== 計算ロジック =====
function computeNormal(){
  const rally=+document.getElementById('rally').value;
  const prep =+document.getElementById('prep').value;
  const rows=[...document.querySelectorAll('#tbody tr')].map(r=>({
    r, name:(r.querySelector('input[type=text]').value||'Player'),
    march:+r.querySelector('.march').value
  }));
  const base=new Date(nowUTC().getTime()+prep*1000);
  const max = Math.max(...rows.map(x=>x.march),0);
  const impact = new Date(base.getTime()+max*1000+rally*60*1000);
  rows.forEach(x=>{
    const depart=new Date(base.getTime()+(max-x.march)*1000);
    x.r.children[3].textContent = `${fmtUTC(depart)} UTC`;
    x.depart = depart;
  });
  document.getElementById('normalPreview').textContent = `共通着弾予定：${fmtUTC(impact)} UTC`;
  renderCopy(rally, rows, impact);
}
function computeReverse(){
  const rally=+document.getElementById('rallyReverse').value;
  const H=+document.getElementById('hh').value, M=+document.getElementById('mm').value, S=+document.getElementById('ss').value;
  const target=new Date(nowUTC()); target.setUTCHours(H,M,S,0);
  const rows=[...document.querySelectorAll('#tbody tr')].map(r=>({
    r, name:(r.querySelector('input[type=text]').value||'Player'),
    march:+r.querySelector('.march').value
  }));
  rows.forEach(x=>{
    const depart=new Date(target.getTime()-rally*60*1000-x.march*1000);
    x.r.children[3].textContent = `${fmtUTC(depart)} UTC`;
    x.depart = depart;
  });
  renderCopy(rally, rows, target);
}
document.getElementById('fireNormal').onclick=computeNormal;
document.getElementById('fireReverse').onclick=computeReverse;

// ===== コピー =====
function renderCopy(rally,rows,impact){
  const lines = [`(${rally}分集結お願いします！)`,''];
  rows.forEach(x=>{
    const icon = x.r.querySelector('.pet')?.checked ? '🐶':'⚪';
    lines.push(`${icon}${x.name}　${fmtUTC(x.depart)} UTC`);
  });
  lines.push('',`着弾：${fmtUTC(impact)} UTC`);
  document.getElementById('copyBox').textContent = lines.join('\n');
}
document.getElementById('copyBtn').onclick=async()=>{
  const text=document.getElementById('copyBox').textContent;
  try{await navigator.clipboard.writeText(text); alert('コピーしました！');}
  catch{
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    alert('コピーしました！');
  }
};
</script>
</body>
</html>