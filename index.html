<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é›†çµæ™‚é–“è¨ˆç®—æ©Ÿ</title>
<style>
:root{--navy:#1565C0;--bg:#f7f9ff;--text:#1f2937;--line:#e5e7eb;--muted:#6b7280}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
     font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
header{text-align:center;padding:10px 0 6px}
.clock{font-size:1.4rem;font-weight:800;color:var(--navy)}
main{max-width:680px;margin:0 auto;padding:10px}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}

label{font-size:13px;color:#374151}
select,input[type="text"]{font-size:14px;padding:6px;border:1px solid var(--line);border-radius:8px;width:100%}

button{border:none;border-radius:8px;font-weight:800;transition:.2s}
.btn-primary{width:100%;padding:12px 0;background:var(--navy);color:#fff;margin-top:8px}
.btn-primary:active{transform:scale(.98)}
.small{width:auto;padding:6px 12px;font-size:18px;margin:4px;border-radius:8px}
#addBtn{background:#e5e7eb}
#removeBtn{background:#fee2e2;color:#b91c1c}

.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;text-align:center;font-size:14px}
th,td{border:1px solid var(--line);padding:6px}
th{background:#f0f4ff;color:#0f4aa8;font-weight:700}
tbody tr:nth-child(odd){background:#fcfdff}
tr.pet-on{background:#eaf3ff !important;box-shadow:inset 0 0 0 2px #cfe2ff}
.nameCell input{font-size:13px;padding:6px}

/* ãƒšãƒƒãƒˆåˆ—ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆå…ˆé ­ã¨æœ€å¾Œã®åˆ—ï¼‰ */
.hide-pet th:first-child,.hide-pet td:first-child,
.hide-pet th:last-child,.hide-pet td:last-child{display:none}

#impactDisplay{margin:8px 0;text-align:center;color:var(--navy);font-weight:800}
#impactText{font-size:1.2rem}

#copyBox{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;
         background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;min-height:64px}
footer{text-align:center;color:#9aa3b2;font-size:12px;padding:12px 0 20px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<header>
  ç¾åœ¨æ™‚åˆ»ã€€<span id="utcClock" class="clock">--:--:--</span> UTC
</header>

<main>

  <!-- ãƒ¢ãƒ¼ãƒ‰ & è¨­å®šï¼ˆè¢«ã› / ç€å¼¾æ™‚åˆ»æŒ‡å®šï¼‰ -->
  <section class="card">
    <label>ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼š</label>
    <select id="mode">
      <option value="normal" selected>è¢«ã›é›†çµ</option>
      <option value="reverse">ç€å¼¾æ™‚åˆ»æŒ‡å®š</option>
    </select>

    <!-- è¢«ã›é›†çµãƒ¢ãƒ¼ãƒ‰ -->
    <div id="normalBox" style="display:block;margin-top:8px">
      <button id="calcBtnNormal" class="btn-primary">æ•µé›†çµãŒããŸï¼</button>
      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <label>ç§’å¾Œã«ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</label>
          <select id="prep">
            <option>30</option><option>60</option><option>90</option><option>120</option>
          </select>
        </div>
        <div style="flex:1">
          <label>åˆ†é›†çµï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</label>
          <select id="rally">
            <option>5</option><option>10</option><option>15</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ç€å¼¾æ™‚åˆ»æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ -->
    <div id="reverseBox" style="display:none;margin-top:8px">
      <label>ç€å¼¾æ™‚åˆ»ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</label>
      <div class="row">
        <select id="hh" style="flex:1"></select> :
        <select id="mm" style="flex:1"></select> :
        <select id="ss" style="flex:1"></select>
      </div>
      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <label>åˆ†é›†çµï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</label>
          <select id="rallyReverse">
            <option>5</option><option>10</option><option>15</option>
          </select>
        </div>
      </div>
      <button id="calcBtnReverse" class="btn-primary">è¨ˆç®—ã™ã‚‹</button>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:6px">
      <div>
        <button id="addBtn" class="small">ï¼‹</button>
        <button id="removeBtn" class="small">âˆ’</button>
      </div>
      <label><input type="checkbox" id="showPet" checked> ãƒšãƒƒãƒˆè¡¨ç¤º</label>
    </div>
  </section>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <section class="card table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>ğŸ¶</th><th>é›†çµä¸»</th><th>è¡Œè»</th><th>å‡ºç™º(UTC)</th><th>ğŸ¶ æ®‹ã‚Š</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td><input type="checkbox" class="pet"></td>
          <td class="nameCell"><input type="text" placeholder="ä¾‹ï¼šMarine"></td>
          <td><select class="march"></select></td>
          <td>-</td>
          <td class="pet-time">-</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ä¸‹éƒ¨ã®å…±é€šç€å¼¾ï¼ˆâ€»ç€å¼¾æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼‰ -->
  <div id="impactDisplay" style="display:block">
    <div style="font-size:13px;color:#6b7280">å…±é€šç€å¼¾æ™‚åˆ»</div>
    <div id="impactText">--:--:-- UTC</div>
  </div>

  <!-- ã‚³ãƒ”ãƒ¼ -->
  <section class="card">
    <label>ã‚³ãƒ”ãƒ¼ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
    <div id="copyBox">ï¼ˆè¨ˆç®—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>
    <button id="copyBtn" class="btn-primary" style="margin-top:6px">ã‚³ãƒ”ãƒ¼</button>
  </section>

</main>

<footer>Â© 1524 Off_Marine</footer>

<script>
/* ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const pad=n=>String(n).padStart(2,'0');
const fmt=(h,m,s)=>`${pad(h)}:${pad(m)}:${pad(s)}`;
const fmtUTC=d=>fmt(d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds());
const nowUTC=()=>new Date();
setInterval(()=>{document.getElementById('utcClock').textContent=fmtUTC(nowUTC());},1000);

/* ===== è¡Œè»ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆ34ã€œ180ç§’ï¼‰ ===== */
function fillMarch(sel){
  for(let s=34;s<=180;s++){
    const m=Math.floor(s/60),sec=s%60;
    const label=(m?`${m}åˆ†`:'')+`${sec}ç§’`;
    sel.add(new Option(label, s));
  }
}
document.querySelectorAll('.march').forEach(fillMarch);

/* ===== ç€å¼¾æŒ‡å®šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ =====
   æ™‚ï¼š12ã€œ16
   åˆ†ï¼š0ã€œ58ï¼ˆ2åˆ†åˆ»ã¿ï¼‰
   ç§’ï¼š0ã€œ50ï¼ˆ10ç§’åˆ»ã¿ï¼‰ */
(function fillImpactSelectors(){
  const hh=document.getElementById('hh');
  const mm=document.getElementById('mm');
  const ss=document.getElementById('ss');
  for(let h=12;h<=16;h++) hh.add(new Option(pad(h), pad(h)));
  for(let m=0;m<60;m+=2) mm.add(new Option(pad(m), pad(m)));
  for(let s=0;s<60;s+=10) ss.add(new Option(pad(s), pad(s)));
  hh.value='12'; mm.value='00'; ss.value='00';
})();

/* ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ===== */
const modeSel=document.getElementById('mode');
function applyMode(){
  const reverse=modeSel.value==='reverse';
  document.getElementById('normalBox').style.display= reverse?'none':'block';
  document.getElementById('reverseBox').style.display= reverse?'block':'none';
  // ä¸‹ã®å…±é€šç€å¼¾ã¯ã€Œè¢«ã›ã®ã¿ã€è¡¨ç¤º
  document.getElementById('impactDisplay').style.display= reverse?'none':'block';
}
modeSel.addEventListener('change',applyMode); applyMode();

/* ===== ãƒšãƒƒãƒˆåˆ— è¡¨ç¤º/éè¡¨ç¤º ===== */
document.getElementById('showPet').addEventListener('change',e=>{
  document.getElementById('tbl').classList.toggle('hide-pet',!e.target.checked);
});

/* ===== è¡Œè¿½åŠ /å‰Šé™¤ ===== */
document.getElementById('addBtn').addEventListener('click',()=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="checkbox" class="pet"></td>
    <td class="nameCell"><input type="text" placeholder="åå‰"></td>
    <td><select class="march"></select></td>
    <td>-</td><td class="pet-time">-</td>`;
  document.getElementById('tbody').appendChild(tr);
  fillMarch(tr.querySelector('.march'));
  setPetHandlers();
});
document.getElementById('removeBtn').addEventListener('click',()=>{
  const rows=document.querySelectorAll('#tbody tr');
  if(rows.length>1) rows[rows.length-1].remove();
});

/* ===== ãƒšãƒƒãƒˆï¼šãƒã‚§ãƒƒã‚¯=2æ™‚é–“ã‚«ã‚¦ãƒ³ãƒˆ ===== */
const PET_MS=2*60*60*1000;
function setPetHandlers(){
  document.querySelectorAll('.pet').forEach(cb=>{
    cb.onchange=()=>{
      const row=cb.closest('tr');
      const cell=row.querySelector('.pet-time');
      if(cb.checked){
        row.dataset.petEnd=(Date.now()+PET_MS).toString();
        row.classList.add('pet-on'); // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      }else{
        delete row.dataset.petEnd;
        row.classList.remove('pet-on');
        cell.textContent='-';
      }
    };
  });
}
setPetHandlers();

/* 1ç§’ã”ã¨ã«æ®‹ã‚Šæ™‚é–“æ›´æ–° */
setInterval(()=>{
  document.querySelectorAll('#tbody tr').forEach(row=>{
    if(!row.dataset.petEnd) return;
    const diff=row.dataset.petEnd-Date.now();
    const cell=row.querySelector('.pet-time');
    if(diff<=0){row.classList.remove('pet-on');cell.textContent='âš« çµ‚äº†';delete row.dataset.petEnd;return;}
    const h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);
    cell.textContent=`ğŸ¶ ${h}:${pad(m)}:${pad(s)}`;
  });
},1000);

/* ===== è¨ˆç®—ï¼šè¢«ã› ===== */
function computeNormal(){
  const rally=+document.getElementById('rally').value;   // åˆ†
  const prep =+document.getElementById('prep').value;    // ç§’
  const rows=[...document.querySelectorAll('#tbody tr')].map(r=>{
    return {r, name:(r.querySelector('input[type=text]').value||'Player'),
            march:+r.querySelector('.march').value};
  });
  const now=nowUTC();
  const base=new Date(now.getTime()+prep*1000);
  const max=Math.max(...rows.map(x=>x.march),0);
  const impact=new Date(base.getTime()+max*1000+rally*60*1000);
  rows.forEach(x=>{
    const depart=new Date(base.getTime()+(max-x.march)*1000);
    x.r.children[3].textContent=`${fmtUTC(depart)} UTC`;
    x.depart=depart;
  });
  document.getElementById('impactText').textContent=`${fmtUTC(impact)} UTC`;
  renderCopy(rally,rows,impact);
}

/* ===== è¨ˆç®—ï¼šç€å¼¾æ™‚åˆ»æŒ‡å®š ===== */
function computeReverse(){
  const rally=+document.getElementById('rallyReverse').value; // åˆ†
  const H=+document.getElementById('hh').value;
  const M=+document.getElementById('mm').value;
  const S=+document.getElementById('ss').value;
  const target=new Date(nowUTC()); target.setUTCHours(H,M,S,0);

  const rows=[...document.querySelectorAll('#tbody tr')].map(r=>{
    return {r, name:(r.querySelector('input[type=text]').value||'Player'),
            march:+r.querySelector('.march').value};
  });
  rows.forEach(x=>{
    const depart=new Date(target.getTime()-rally*60*1000-x.march*1000);
    x.r.children[3].textContent=`${fmtUTC(depart)} UTC`;
    x.depart=depart;
  });
  // è¢«ã›ç”¨ã®ä¸‹éƒ¨è¡¨ç¤ºã¯éš ã—ã¦ã„ã‚‹ãŒã€ã‚³ãƒ”ãƒ¼ç”¨ã«ã¯ä½¿ã†
  renderCopy(rally,rows,target);
}

/* ãƒœã‚¿ãƒ³ç´ä»˜ã‘ */
document.getElementById('calcBtnNormal').addEventListener('click',computeNormal);
document.getElementById('calcBtnReverse').addEventListener('click',computeReverse);

/* ===== ã‚³ãƒ”ãƒ¼ç”Ÿæˆ ===== */
function renderCopy(rally,rows,impact){
  const lines=[`${rally}åˆ†é›†çµãŠé¡˜ã„ã—ã¾ã™ï¼ğŸ™‡â€â™‚ï¸âœ¨`,''];
  rows.forEach(x=>{
    const icon = x.r.dataset.petEnd ? 'ğŸ¶' : 'âšª';
    lines.push(`${icon}${x.name}ã€€${fmtUTC(x.depart)} UTC`);
  });
  lines.push('',`ç€å¼¾ï¼š${fmtUTC(impact)} UTC`);
  document.getElementById('copyBox').textContent=lines.join('\n');
}

/* ===== ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ ===== */
document.getElementById('copyBtn').addEventListener('click',async()=>{
  try{await navigator.clipboard.writeText(document.getElementById('copyBox').textContent);
      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');}
  catch{const ta=document.createElement('textarea');ta.value=document.getElementById('copyBox').textContent;
        document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');}
});
</script>
</body>
</html>