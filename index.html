<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é›†çµæ™‚é–“è¨ˆç®—æ©Ÿï¼ˆArrival Marine UTCï¼‰</title>

<!-- ğŸ“± iPhone / PWA -->
<link rel="icon" href="icon-1524.png">
<link rel="apple-touch-icon" href="icon-1524.png">
<meta name="apple-mobile-web-app-title" content="é›†çµæ™‚é–“è¨ˆç®—æ©Ÿ">
<meta name="application-name" content="é›†çµæ™‚é–“è¨ˆç®—æ©Ÿ">
<meta name="theme-color" content="#1565C0">

<style>
:root{
  --navy:#1565C0;
  --bg:#f8faff;
  --text:#1f2937;
  --line:#d1d5db;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
}
header{ text-align:center; padding:18px 0 8px; }
.clock{
  background:#eef3fb;color:var(--navy);
  display:inline-block;padding:12px 20px;border-radius:10px;
  font-size:1.6rem;font-weight:700;font-variant-numeric:tabular-nums;
}
main{ max-width:860px;margin:0 auto;padding:10px; }
.card{
  background:#fff;border:1px solid var(--line);border-radius:12px;
  padding:14px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.02);
}
label{ font-size:13px;color:#6b7280;margin-bottom:4px;display:block; }
select,input,button{ font-size:15px;border-radius:10px; }
select,input[type="number"],input[type="time"],input[type="text"]{
  width:100%;padding:8px;border:1px solid var(--line);background:#fff;
}

/* å³ä¸Šã®ï¼‹âˆ’ï¼ˆæ§ãˆã‚ï¼‰ */
.actions-top{
  display:flex;justify-content:flex-end;gap:6px;margin-bottom:6px;
}
.actions-top button{
  width:34px;height:34px;border-radius:50%;
  font-size:18px;font-weight:600;border:1px solid #d1d5db;
  background:#f9fafb;color:#4b5563;transition:.2s;
}
.actions-top button:hover{ background:#e5e7eb;transform:translateY(-1px); }

/* ãƒ¡ã‚¤ãƒ³ã€Œè¨ˆç®—ã™ã‚‹ã€ãƒœã‚¿ãƒ³ */
#calcBtn{
  width:100%;background:var(--navy);color:#fff;
  font-size:18px;font-weight:700;border:none;border-radius:10px;
  padding:14px 0;margin-top:12px;
  box-shadow:0 3px 8px rgba(21,101,192,.30);transition:all .2s;
}
#calcBtn:hover{ background:#0b4aa8;transform:translateY(-1px); }
#calcBtn:active{ background:#09438d;transform:translateY(1px); }

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
table{ width:100%;border-collapse:collapse; }
th,td{ border:1px solid var(--line);padding:8px;text-align:center;font-size:14px; }
th{ background:#f0f4ff;color:#1e3a8a;font-weight:600; }
tbody tr:nth-child(odd){ background:#fafbff; }

.pet-status{ font-weight:500; }
.pet-active{ color:var(--navy); }
.pet-inactive{ color:#9ca3af; }

#copyBox{
  white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;
  background:#fff;border:1px solid var(--line);border-radius:10px;
  padding:10px;min-height:70px;
}

@media (max-width:600px){
  th,td{ font-size:13px;padding:6px; }
  .clock{ font-size:1.4rem; }
}
</style>
</head>
<body>
<header><div class="clock" id="utcClock">UTC --:--:--</div></header>

<main>
  <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
  <section class="card">
    <label>ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</label>
    <select id="mode">
      <option value="normal" selected>è¢«ã›é›†çµãƒ¢ãƒ¼ãƒ‰ã€€â€»ä»Šã™ã</option>
      <option value="reverse">ç€æ™‚é–“æŒ‡å®šãƒ¢ãƒ¼ãƒ‰</option>
    </select>
  </section>

  <!-- è¨­å®š -->
  <section class="card">
    <!-- å³ä¸Šï¼šï¼‹ âˆ’ -->
    <div class="actions-top">
      <button id="addBtn" title="è¡Œã‚’è¿½åŠ ">ï¼‹</button>
      <button id="removeBtn" title="æœ€å¾Œã®è¡Œã‚’å‰Šé™¤">âˆ’</button>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1 1 120px;">
        <label>æº–å‚™æ™‚é–“ï¼ˆç§’ï¼‰</label>
        <select id="prep">
          <option value="30">30</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120">120</option>
        </select>
      </div>
      <div style="flex:1 1 120px;">
        <label>é›†çµæ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <select id="rally">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>
      <div id="impactBox" style="flex:1 1 170px;display:none;">
        <label>å…±é€šç€å¼¾æ™‚åˆ»ï¼ˆUTCï¼‰</label>
        <input type="time" id="impactTime" step="1" value="12:10:00">
      </div>
    </div>

    <!-- ä¸»ãƒœã‚¿ãƒ³ -->
    <button id="calcBtn">è¨ˆç®—ã™ã‚‹</button>
  </section>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <section class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>ğŸ¶</th>
          <th>é›†çµä¸»</th>
          <th>è¡Œè»ï¼ˆä½•åˆ†ä½•ç§’ï¼‰</th>
          <th>å‡ºç™ºï¼ˆUTCï¼‰</th>
          <th>ãƒšãƒƒãƒˆ</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td><input type="checkbox" class="pet"></td>
          <td><input type="text" placeholder="ä¾‹ï¼šMarine"></td>
          <td><select class="march" id="marchSelect"></select></td>
          <td>-</td>
          <td class="pet-status pet-inactive">âšª â€•</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" style="text-align:right;font-weight:600;">å…±é€šç€å¼¾ï¼ˆUTCï¼‰</td>
          <td colspan="2" id="commonImpact">-</td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ã‚³ãƒ”ãƒ¼ -->
  <section class="card">
    <label>ã‚³ãƒ”ãƒ¼ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
    <div id="copyBox">ï¼ˆè¨ˆç®—ã™ã‚‹ã¨ã“ã“ã«æ•´å½¢ãƒ†ã‚­ã‚¹ãƒˆãŒå‡ºã¾ã™ï¼‰</div>
    <div style="margin-top:8px;">
      <button id="copyBtn" style="padding:10px 14px;border:1px solid var(--line);background:#f9fafb;border-radius:8px">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </section>

  <footer style="text-align:center;color:#9ca3af;font-size:12px;padding:10px 0 20px;">
    Â© 1524 Off_Marine â€” é›†çµæ™‚é–“è¨ˆç®—æ©Ÿ
  </footer>
</main>

<script>
/* ========== æ™‚è¨ˆ ========== */
const pad = n => String(n).padStart(2,'0');
const fmtUTC = d => `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
const nowUTC = () => new Date();
function tickClock(){ document.getElementById('utcClock').textContent = `UTC ${fmtUTC(nowUTC())}`; }
setInterval(tickClock,1000); tickClock();

/* ========== è¡Œè»ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆ13ç§’ã€œ180ç§’ï¼‰ ========== */
document.addEventListener("DOMContentLoaded",()=>{
  const marchSelect=document.getElementById('marchSelect');
  for(let sec=13; sec<=180; sec++){
    const min=Math.floor(sec/60), s=sec%60;
    const opt=document.createElement('option');
    opt.value=sec;
    opt.textContent=`${min}åˆ†${pad(s)}ç§’`;
    marchSelect.appendChild(opt);
  }
});

/* ========== ãƒšãƒƒãƒˆ2æ™‚é–“ã‚¿ã‚¤ãƒãƒ¼ ========== */
const PET_DURATION_MS = 2*60*60*1000;
function setPetListeners(){
  document.querySelectorAll('.pet').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const row = cb.closest('tr');
      if(cb.checked){
        row.dataset.petEnd = (nowUTC().getTime()+PET_DURATION_MS).toString();
        row.dataset.petState = "active";
        updatePetStatus(row);
      }else{
        delete row.dataset.petEnd; delete row.dataset.petState;
        row.querySelector('.pet-status').textContent = "âšª â€•";
      }
    });
  });
}
function updatePetStatus(row){
  const cell=row.querySelector('.pet-status');
  if(!row.dataset.petEnd) return;
  const diff = Number(row.dataset.petEnd) - nowUTC();
  if(diff<=0){ row.dataset.petState="expired"; cell.textContent="âš«ï¸ â€•"; return; }
  const h=Math.floor(diff/3600000), m=Math.floor(diff%3600000/60000), s=Math.floor(diff%60000/1000);
  cell.textContent = `ğŸ”µ ${h}:${pad(m)}:${pad(s)}`;
}
setInterval(()=>document.querySelectorAll('#tbody tr').forEach(updatePetStatus),1000);
setPetListeners();

/* ========== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆç€æ™‚é–“æŒ‡å®šã§å…¥åŠ›æ¬„è¡¨ç¤ºï¼‰ ========== */
document.getElementById('mode').addEventListener('change',()=>{
  const isReverse = document.getElementById('mode').value === "reverse";
  document.getElementById('impactBox').style.display = isReverse ? "block" : "none";
});

/* ========== ï¼‹ è¡Œè¿½åŠ  ========== */
document.getElementById('addBtn').addEventListener('click',()=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="checkbox" class="pet"></td>
    <td><input type="text" placeholder="åå‰"></td>
    <td>${document.getElementById('marchSelect').outerHTML}</td>
    <td>-</td>
    <td class="pet-status pet-inactive">âšª â€•</td>`;
  document.getElementById('tbody').appendChild(tr);
  setPetListeners();
});

/* ========== âˆ’ æœ€å¾Œã®è¡Œå‰Šé™¤ ========== */
document.getElementById('removeBtn').addEventListener('click',()=>{
  const rows = document.querySelectorAll('#tbody tr');
  if(rows.length===0){ alert("å‰Šé™¤ã§ãã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
  rows[rows.length-1].remove();
});

/* ========== è¨ˆç®— ========== */
document.getElementById('calcBtn').addEventListener('click',()=>{
  const rallyMin = +document.getElementById('rally').value;
  const mode = document.getElementById('mode').value;
  const prep = +document.getElementById('prep').value;
  const rows=[...document.querySelectorAll('#tbody tr')];
  const now = nowUTC();

  const members = rows.map(r=>{
    const name = r.children[1].querySelector('input').value.trim() || 'Player';
    const march = +r.querySelector('.march').value;
    const petState = r.dataset.petState || "none";
    return {r,name,march,petState};
  });

  let target;
  if(mode==="normal"){
    const base=new Date(now.getTime()+prep*1000);
    const max=Math.max(...members.map(m=>m.march),0);
    target=new Date(base.getTime()+max*1000+rallyMin*60*1000);
    members.forEach(m=>{
      const depart=new Date(base.getTime()+(max-m.march)*1000);
      m.r.children[3].textContent=`${fmtUTC(depart)} UTC`;
      m.depart=depart;
    });
  }else{
    const [hh,mm,ss="0"]=document.getElementById('impactTime').value.split(':');
    const targetUTC=new Date(nowUTC());
    targetUTC.setUTCHours(+hh,+mm,+ss,0);
    target=targetUTC;
    members.forEach(m=>{
      const depart=new Date(target.getTime()-(rallyMin*60*1000)-(m.march*1000));
      m.r.children[3].textContent=`${fmtUTC(depart)} UTC`;
      m.depart=depart;
    });
  }

  document.getElementById('commonImpact').textContent=`${fmtUTC(target)} UTC`;

  const lines=[`${rallyMin}åˆ†é›†çµãŠé¡˜ã„ã—ã¾ã™ï¼ğŸ™‡â€â™‚ï¸ğŸ™‡â€â™‚ï¸âœ¨`,""];
  members.forEach(m=>{
    let icon="âšªï¸"; if(m.petState==="active") icon="ğŸ¶"; else if(m.petState==="expired") icon="âš«ï¸";
    lines.push(`${icon}${m.name}ã€€${fmtUTC(m.depart)} UTC`);
  });
  lines.push("",`ç€å¼¾ï¼š${fmtUTC(target)} UTC`);
  document.getElementById('copyBox').textContent = lines.join('\n');
});

/* ========== ã‚³ãƒ”ãƒ¼ ========== */
document.getElementById('copyBtn').addEventListener('click',async()=>{
  const txt=document.getElementById('copyBox').textContent;
  try{ await navigator.clipboard.writeText(txt); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'); }
  catch{
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
  }
});
</script>
</body>
</html>