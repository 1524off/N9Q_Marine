<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arrival Marine  (UTC / Navy)</title>
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon.png" />
<meta name="theme-color" content="#1565C0" />
<style>
  :root{
    --navy:#1565C0;
    --bg:#ffffff;
    --line:#e5e7eb;
    --text:#1f2937;
    --muted:#6b7280;
    --btn:#1565C0;
    --btn-text:#ffffff;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  }
  header{ text-align:center; padding:16px 12px 8px }
  header h1{ margin:6px 0 4px; font-size:18px; color:var(--navy); }
  header .clock{ display:inline-block; background:#eef3fb; color:var(--navy); padding:6px 10px; border-radius:8px; font-variant-numeric:tabular-nums; }
  main{ max-width:860px; margin:0 auto; padding:12px; }
  .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; margin:10px 0; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row > div{ flex:1 1 160px; min-width:160px; }
  label{ display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
  select,input[type="number"],input[type="text"]{
    width:100%; padding:10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px;
  }
  button{ background:var(--btn); color:var(--btn-text); border:none; padding:10px 14px; border-radius:10px; font-size:14px; }
  button.secondary{ background:#f3f4f6; color:#111827; border:1px solid var(--line); }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border:1px solid var(--line); padding:10px; text-align:center; font-size:14px; }
  th{ background:#f7f9fc; color:#374151; }
  tfoot td{ background:#fafafa; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .result-box{ white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#fff; border:1px solid var(--line); border-radius:8px; padding:10px; }
</style>
</head>
<body>
<header>
  <h1>Arrival Marine （UTC）</h1>
  <div class="clock" id="utcClock">UTC: --:--:--</div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div>
        <label>準備時間（秒）</label>
        <select id="prep">
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="40">40</option>
          <option value="50">50</option>
          <option value="60">60</option>
          <option value="90">90</option>
        </select>
      </div>
      <div>
        <label>集結時間（分）</label>
        <select id="rally">
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>
      <div class="actions">
        <button class="secondary" id="addBtn">＋ 追加</button>
        <button id="calcBtn">集結がきた！</button>
      </div>
    </div>
  </section>

  <section class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th style="width:36%">集結主</th>
          <th style="width:20%">行軍（秒）</th>
          <th style="width:22%">出発（UTC）</th>
          <th style="width:22%">着弾（UTC）</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td><input type="text" placeholder="例：Marine" /></td>
          <td><input type="number" min="0" step="1" value="300" /></td>
          <td>-</td>
          <td>-</td>
        </tr>
        <tr>
          <td><input type="text" placeholder="例：Yumi" /></td>
          <td><input type="number" min="0" step="1" value="200" /></td>
          <td>-</td>
          <td>-</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="text-align:right; font-weight:600;">共通着弾（UTC）</td>
          <td colspan="2" id="commonImpact">-</td>
        </tr>
      </tfoot>
    </table>
  </section>

  <section class="card">
    <div class="row">
      <div style="flex:1 1 100%">
        <label>コピー用メッセージ</label>
        <div class="result-box" id="copyBox">（計算するとここに整形テキストが出ます）</div>
      </div>
    </div>
    <div class="row">
      <div class="actions">
        <button class="secondary" id="copyBtn">コピー</button>
      </div>
    </div>
  </section>

  <footer style="text-align:center; color:#6b7280; font-size:12px; padding:10px 0 20px;">© Arrival Marine</footer>
</main>

<script>
// Utility
function pad(n){ return String(n).padStart(2,'0'); }
function fmtUTC(d){ return `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`; }
function nowUTC(){ return new Date(); }

// Live UTC clock
function tickClock(){
  const n = nowUTC();
  document.getElementById('utcClock').textContent = `UTC: ${fmtUTC(n)}`;
}
setInterval(tickClock, 1000); tickClock();

// Row management
const tbody = document.getElementById('tbody');
document.getElementById('addBtn').addEventListener('click', () => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="名前" /></td>
    <td><input type="number" min="0" step="1" value="150" /></td>
    <td>-</td>
    <td>-</td>
  `;
  tbody.appendChild(tr);
});

// Core logic (your confirmed specification)
document.getElementById('calcBtn').addEventListener('click', () => {
  const prep = Number(document.getElementById('prep').value || 0);
  const rallyMin = Number(document.getElementById('rally').value || 0);
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const now = nowUTC();

  // Gather data
  const members = rows.map(r => {
    const name = (r.children[0].querySelector('input').value || '').trim() || 'Player';
    const march = Math.max(0, Number(r.children[1].querySelector('input').value || 0));
    return { row: r, name, march };
  }).filter(m => !isNaN(m.march));

  if (members.length === 0){ return; }

  const baseDepart = new Date(now.getTime() + prep * 1000); // 出発開始 = now + 準備
  const maxMarch = Math.max(...members.map(m => m.march)); // 最遅

  const target = new Date(baseDepart.getTime() + maxMarch * 1000 + rallyMin * 60 * 1000); // 共通着弾

  // Fill results per member
  members.forEach(m => {
    const depart = new Date(baseDepart.getTime() + (maxMarch - m.march) * 1000); // 遅いほど早く出発
    m.row.children[2].textContent = `${fmtUTC(depart)} UTC`;
    m.row.children[3].textContent = `${fmtUTC(target)} UTC`;
    m.depart = depart;
  });

  document.getElementById('commonImpact').textContent = `${fmtUTC(target)} UTC`;

  // Build copy text
  let lines = [];
  lines.push('集結お願いします！🙇‍♂️🙇‍♂️✨');
  lines.push(''); // blank line
  members.forEach(m => {
    lines.push(`${m.name}　${fmtUTC(m.depart)} UTC`); // full-width space between name and time
  });
  lines.push('');
  lines.push(`着弾：${fmtUTC(target)} UTC`);

  const msg = lines.join('\n');
  document.getElementById('copyBox').textContent = msg;
});

document.getElementById('copyBtn').addEventListener('click', async () => {
  const txt = document.getElementById('copyBox').textContent;
  try{
    await navigator.clipboard.writeText(txt);
    alert('コピーしました。');
  }catch(e){
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert('コピーしました。');
  }
});

// PWA
if ('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  });
}
</script>
</body>
</html>
