<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arrival Marine 集結計算</title>
<style>
:root {
  --navy: #1565C0;
  --bg: #f7f9ff;
  --text: #1f2937;
  --line: #d1d5db;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
}
header {
  text-align: center;
  padding: 14px 0 8px;
  background: #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
}
.clock {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--navy);
  font-family: "Roboto Mono", monospace;
}
main {
  max-width: 620px;
  margin: 0 auto;
  padding: 10px;
}
.card {
  background: #fff;
  border-radius: 10px;
  border: 1px solid var(--line);
  padding: 12px 14px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
label {
  font-size: 13px;
  color: #374151;
  font-weight: 600;
}
select, input[type="text"] {
  font-size: 15px;
  padding: 8px 10px;
  border: 1px solid var(--line);
  border-radius: 8px;
  background: #f9fbff;
  width: 100%;
}
button {
  border: none;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: .2s;
}
.btn-primary {
  width: 100%;
  background: var(--navy);
  color: #fff;
  font-size: 1rem;
  padding: 12px 0;
  margin-top: 10px;
}
.btn-primary:hover { background: #1976d2; }
.small {
  font-size: 18px;
  padding: 6px 12px;
  margin: 3px;
  background: #eef3ff;
  color: #0f4aa8;
}
#removeBtn { background: #fee2e2; color: #b91c1c; }

.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; text-align: center; font-size: 14px; }
th, td { border: 1px solid var(--line); padding: 8px; }
th { background: #eef3ff; color: #0f4aa8; }
tbody tr:nth-child(odd) { background: #fafcff; }
tr.pet-on { background: #eaf3ff !important; }

#impactDisplay {
  text-align: center;
  color: var(--navy);
  font-weight: 700;
  margin: 10px 0;
}
#impactText {
  font-size: 1.4rem;
  font-family: "Roboto Mono", monospace;
}
#copyBox {
  background: #f5f8ff;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 10px;
  min-height: 64px;
  white-space: pre-wrap;
  font-family: ui-monospace, Menlo, monospace;
  font-size: 0.95rem;
  line-height: 1.5;
}
footer {
  text-align: center;
  color: #9aa3b2;
  font-size: 12px;
  padding: 16px 0 24px;
}
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}
</style>
</head>
<body>
<header>
  現在時刻 <span id="utcClock" class="clock">--:--:--</span> UTC
</header>

<main>
<section class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <label>モード：</label>
    <select id="mode">
      <option value="normal" selected>被せ集結</option>
      <option value="reverse">着弾指定</option>
    </select>
  </div>

  <!-- 被せ集結 -->
  <div id="normalBox" style="margin-top:8px;">
    <div class="row">
      <select id="prep">
        <option>30</option><option>60</option><option>90</option><option>120</option>
      </select> 秒後に
      <select id="rally">
        <option>5</option><option>10</option><option>15</option>
      </select> 分集結
    </div>
    <button id="calcBtnNormal" class="btn-primary">💥 敵集結がきた！</button>
  </div>

  <!-- 着弾指定 -->
  <div id="reverseBox" style="display:none;margin-top:10px;">
    <div class="row">
      <select id="hh"></select> : <select id="mm"></select> : <select id="ss"></select>
    </div>
    <div class="row">
      <label>分集結</label>
      <select id="rallyReverse"><option>5</option><option>10</option><option>15</option></select>
    </div>
    <button id="calcBtnReverse" class="btn-primary">計算する</button>
  </div>

  <div class="row" style="justify-content:space-between;margin-top:8px;">
    <div>
      <button id="addBtn" class="small">＋</button>
      <button id="removeBtn" class="small">−</button>
    </div>
    <label><input type="checkbox" id="showPet" checked> ペット表示</label>
  </div>
</section>

<section class="card table-wrap">
  <table id="tbl">
    <thead>
      <tr><th>🐶</th><th>集結主</th><th>行軍</th><th>出発(UTC)</th><th>🐶 残り</th></tr>
    </thead>
    <tbody id="tbody">
      <tr>
        <td><input type="checkbox" class="pet"></td>
        <td><input type="text" placeholder="例：Marine"></td>
        <td><select class="march"></select></td>
        <td>-</td><td class="pet-time">-</td>
      </tr>
    </tbody>
  </table>
</section>

<div id="impactDisplay">
  <div style="font-size:13px;color:#6b7280;">共通着弾時刻</div>
  <div id="impactText">--:--:-- UTC</div>
</div>

<section class="card">
  <label>コピー用メッセージ</label>
  <div id="copyBox">（結果がここに表示されます）</div>
  <button id="copyBtn" class="btn-primary">📋 コピー</button>
</section>
</main>

<footer>© 1524 Off_Marine</footer>

<script>
// --- 時計 ---
const pad=n=>String(n).padStart(2,"0");
const fmtUTC=d=>`${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
const nowUTC=()=>new Date();
setInterval(()=>{document.getElementById("utcClock").textContent=fmtUTC(nowUTC());},1000);

// --- 行軍 ---
function fillMarch(sel){for(let s=34;s<=180;s++){const m=Math.floor(s/60),sec=s%60;sel.add(new Option((m?`${m}分`:"")+`${sec}秒`,s));}}
document.querySelectorAll(".march").forEach(fillMarch);

// --- 着弾指定 ---
(function(){const hh=document.getElementById("hh"),mm=document.getElementById("mm"),ss=document.getElementById("ss");
for(let h=12;h<=16;h++)hh.add(new Option(pad(h),pad(h)));
for(let m=0;m<60;m+=2)mm.add(new Option(pad(m),pad(m)));
for(let s=0;s<60;s+=10)ss.add(new Option(pad(s),pad(s)));
hh.value="12";mm.value="00";ss.value="00";})();

// --- モード切替 ---
const modeSel=document.getElementById("mode");
modeSel.onchange=()=>{const rev=modeSel.value==="reverse";
document.getElementById("normalBox").style.display=rev?"none":"block";
document.getElementById("reverseBox").style.display=rev?"block":"none";
document.getElementById("impactDisplay").style.display=rev?"none":"block";};

// --- 行追加/削除 ---
document.getElementById("addBtn").onclick=()=>{const tr=document.createElement("tr");
tr.innerHTML=`<td><input type="checkbox" class="pet"></td><td><input type="text" placeholder="名前"></td><td><select class="march"></select></td><td>-</td><td class="pet-time">-</td>`;
document.getElementById("tbody").appendChild(tr);fillMarch(tr.querySelector(".march"));};
document.getElementById("removeBtn").onclick=()=>{const rows=document.querySelectorAll("#tbody tr");if(rows.length>1)rows[rows.length-1].remove();};

// --- 計算 ---
function computeNormal(){
  const rally=+document.getElementById("rally").value,prep=+document.getElementById("prep").value;
  const rows=[...document.querySelectorAll("#tbody tr")].map(r=>({r,name:r.querySelector("input[type=text]").value||"Player",march:+r.querySelector(".march").value}));
  const base=new Date(nowUTC().getTime()+prep*1000);
  const max=Math.max(...rows.map(x=>x.march),0);
  const impact=new Date(base.getTime()+max*1000+rally*60*1000);
  rows.forEach(x=>{const depart=new Date(base.getTime()+(max-x.march)*1000);x.r.children[3].textContent=`${fmtUTC(depart)} UTC`;x.depart=depart;});
  document.getElementById("impactText").textContent=`${fmtUTC(impact)} UTC`;
  renderCopy(rally,rows,impact);
}
function computeReverse(){
  const rally=+document.getElementById("rallyReverse").value;
  const H=+document.getElementById("hh").value,M=+document.getElementById("mm").value,S=+document.getElementById("ss").value;
  const target=new Date(nowUTC());target.setUTCHours(H,M,S,0);
  const rows=[...document.querySelectorAll("#tbody tr")].map(r=>({r,name:r.querySelector("input[type=text]").value||"Player",march:+r.querySelector(".march").value}));
  rows.forEach(x=>{const depart=new Date(target.getTime()-rally*60*1000-x.march*1000);
  x.r.children[3].textContent=`${fmtUTC(depart)} UTC`;x.depart=depart;});
  renderCopy(rally,rows,target);
}
document.getElementById("calcBtnNormal").onclick=computeNormal;
document.getElementById("calcBtnReverse").onclick=computeReverse;

// --- コピー欄 ---
function renderCopy(rally,rows,impact){
  const lines=[`(${rally}分集結お願いします！)`,''];
  rows.forEach(x=>lines.push(`⚪${x.name}　${fmtUTC(x.depart)} UTC`));
  lines.push('',`着弾：${fmtUTC(impact)} UTC`);
  document.getElementById("copyBox").textContent=lines.join("\n");
}
document.getElementById("copyBtn").onclick=async()=>{
  const text=document.getElementById("copyBox").textContent;
  try{await navigator.clipboard.writeText(text);alert("コピーしました！");}
  catch{const ta=document.createElement("textarea");ta.value=text;document.body.appendChild(ta);
  ta.select();document.execCommand("copy");ta.remove();alert("コピーしました！");}
};
</script>
</body>
</html>